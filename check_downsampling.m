close all; clear all; clc;

resampled = [4050	4262.65980640426	4089.99876705073	3597.81623287926	2920.52157442443	2229	1688.17346532734	1423.88073322148	1490.99922406333	1864.21480445308	2447	3097.19662319858	3662.60917057465	4017.76629603156	4092.87536504402	3888	3466.65655444214	2942.74621797500	2442.91356883683	2073.19514758445	1891.00000000000	1889.72387288089	2010.72944629642	2160.93960199177	2246.49578788116	2205	2025.20977578689	1757.67185217975	1494.88506888276	1342.64776354334	1385.00000000000	1652.85955575313	2119.12795072082	2699.62765809110	3278.53398161556	3741	4000.98379104505	4027.91855390056	3842.36120632207	3503.03258029131	3083	2644.10400192708	2228.92433346017	1854.75385665301	1524.95891930702	1244	1026.77573655677	906.472309448630	918.853991795003	1084.20804326782	1388.00000000000	1766.48501754498	2128.75138945355	2363.74123663516	2379.23920652148	2135	1661.72661007482	1064.15542094870	491.164414582014	97.5778925765772	1.16773880557374e-13	239.378311300670	777.961794847453	1500.13862443960	2248.42407535189	2867	3239.51403683888	3327.07891795211	3160.91522856609	2831.20886263682	2457	2149.17099524516	1988.17657748781	2000.72073371987	2162.53974405852	2413	2673.95108666011	2885.48076336922	3010.97724365741	3047.09617691309	3019	2963.09879787918	2922.87584296820	2922.87584296820	2963.09879787918	3019	3047.09617691309	3010.97724365741	2885.48076336922	2673.95108666011	2413	2162.53974405852	2000.72073371987	1988.17657748781	2149.17099524515	2457	2831.20886263682	3160.91522856609	3327.07891795211	3239.51403683888	2867	2248.42407535189	1500.13862443960	777.961794847453	239.378311300669	1.16773880557374e-13	97.5778925765772	491.164414582014	1064.15542094870	1661.72661007483	2135	2379.23920652148	2363.74123663516	2128.75138945355	1766.48501754498	1388.00000000000	1087.79378644639	926.137105900491	915.431210029753	1033.47767436783	1244	1515.50045845675	1836.84183999005	2208.12938790270	2629.28892774903	3083	3522.36630984298	3877.82076890356	4067.93263917072	4028.77716650638	3741	3243.80259989519	2637.10287417836	2049.75449591951	1605.40736865958	1385.00000000000	1400.39013847269	1597.65417758720	1870.53189042240	2101.70214699600	2205	2154.81502428005	1998.74056697428	1833.47487871430	1770.04094781729	1891.00000000000	2216.07395906818	2695.68917805449	3219.39458559226	3654.03881460570	3888	3866.42389022226	3613.21541879151	3214.16247076872	2788.41678483132	2447	2255.59537132991	2214.46860236653	2261.96962225210	2299.58110447900	2229	1986.80016091473	1570.76108536387	1035.78817702954	477.311778813352];
resampled_copy = resampled;
resampled_copy = resampled_copy ./max(abs(resampled_copy));

%correct magnitudes
tx_sub_mag = [ 0.6294    0.8116   -0.7460    0.8268    0.2647   -0.8049   -0.4430    0.0938    0.9150    0.9298   -0.6848    0.9412    0.9143   -0.0292    0.6006 -0.7162];
rx_sub_mag = [ 0.4964
    0.6576
    0.9421
    0.7052
    0.1084
    1.0000
    0.6185
    0.1013
    0.8010
    0.8299
    0.8719
    0.8472
    0.8426
    0.2402
    0.5338
    0.6619];

%tx_signal = [4050, 2229, 2447, 3888, 1891, 2205, 1385, 3741, 3083, 1244, 1388, 2135, 0, 2867, 2457, 2413, 3019, 3019, 2413, 2457, 2867, 0, 2135, 1388, 1244, 3083, 3741, 1385, 2205, 1891, 3888, 2447, 2229, 0];
tx_signal = [4050, 2229, 2447, 3888, 1891, 2205, 1385, 3741, 3083, 1244, 1388, 2135, 0, 2867, 2457, 2413, 3019, 3019, 2413, 2457, 2867, 0, 2135, 1388, 1244, 3083, 3741, 1385, 2205, 1891, 3888, 2447, 2229];
tx_signal = tx_signal - mean((tx_signal));

filler = zeros(1,1001-length(tx_signal));
tx_filled = [tx_signal filler];
RX = fft(tx_filled);
posRX = abs(RX(1:1+(length(RX)-1)/2));
posRX = posRX ./ max(abs(posRX));

figure; hold on;
plot(posRX,'LineWidth',2);
tx_sub_mag = abs(tx_sub_mag);
tx_to_plot = tx_sub_mag./max(abs(tx_sub_mag));
%plot(linspace(0,length(posRX),length(tx_sub_mag)),tx_to_plot,'-rs','LineWidth', 2);

[test_raw_downsamp, frequencies] = downsamp_to_subcarriers(tx_filled, 1e9, 1e9, 16, tx_sub_mag);
frequencies = (frequencies./1000000);
test_raw_downsamp = test_raw_downsamp ./ abs(max(test_raw_downsamp));
tx_sub_mag = tx_sub_mag ./ max(abs(tx_sub_mag));
plot(linspace(frequencies(1),frequencies(end),length(test_raw_downsamp)),test_raw_downsamp,'-cs','LineWidth', 2);
plot(linspace(frequencies(1),frequencies(end),length(tx_sub_mag)),tx_sub_mag, '-rs','LineWidth', 2);
%plot(linspace(frequencies(1),frequencies(end),length(posRX)),posRX,'-b','LineWidth',2);



fs_scope = 5e9;                     % Tek sampling frequency
fs_tx = 1e9;                        % GageTx sampling frequency
Nsub = 16;                          % Number of sub-carriers in tx

% Zero-mean each signal... NOT SURE IF NEED
resampled = resampled - mean(resampled);

% MAKE IT 5001 samples long. NOT SURE IF NEED OR WANT
filler = zeros(1,5001-length(resampled));
resampled = [resampled filler];


[testspec, ~] = downsamp_to_subcarriers(resampled, fs_scope, fs_tx, Nsub, tx_sub_mag);


%zero mean
% tx_sub_mag = tx_sub_mag - mean(tx_sub_mag);
% testspec = testspec - mean(testspec);

%normalize
tx_sub_mag = [ 0.6294    0.8116   -0.7460    0.8268    0.2647   -0.8049   -0.4430    0.0938    0.9150    0.9298   -0.6848    0.9412    0.9143   -0.0292    0.6006 -0.7162];
tx_sub_mag = tx_sub_mag./max(abs(tx_sub_mag));
testspec = testspec./max(abs(testspec));
%test_raw_downsamp = test_raw_downsamp./max(abs(test_raw_downsamp));
%testspec = testspec ./ tx_sub_mag';

figure; hold on;
grid on;
plot(abs(tx_sub_mag),'-bs','LineWidth',2);
plot(testspec,'-rs','LineWidth', 2);
legend('Specified subcarrier magnitudes', 'Experimental data magnitudes','Location','Best');

% figure; hold on;
% plot(linspace(1,length(tx_signal),length(resampled_copy)), resampled_copy,'LineWidth',2);
% plot(tx_signal, '-rs', 'LineWidth', 2);

mean(tx_sub_mag)